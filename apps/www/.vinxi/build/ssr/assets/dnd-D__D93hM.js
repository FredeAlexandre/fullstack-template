import{jsx as s,jsxs as L}from"react/jsx-runtime";import{createContext as lt,useState as F,useRef as A,useContext as q,useEffect as Q}from"react";import{useSensors as _,useSensor as H,PointerSensor as X,KeyboardSensor as Y,DndContext as W,closestCenter as M,useDraggable as tt,useDroppable as dt}from"@dnd-kit/core";import{B as pt}from"./button-U5Omqg_X.js";import{useSortable as st,sortableKeyboardCoordinates as nt,SortableContext as et,verticalListSortingStrategy as ot,arrayMove as rt}from"@dnd-kit/sortable";import{ChevronUp as it,ChevronDown as at}from"lucide-react";const ut={contracts:[],functions:[],addContract:()=>{},addFunction:()=>{},addFunctionToContract:()=>{},delFunctionContract:()=>{},changeFunctionName:()=>{},changeFunctionView:()=>{},getFunctionName:()=>"function",getFunctionView:()=>!0,updatePosition:()=>{}},z=lt(ut),ft=({children:n})=>{const[D,b]=F([]),[y,C]=F([]),K=a=>{b(i=>[...i,a])},x=a=>C(i=>[...i,a]),T=(a,i)=>{b(e=>e.map(t=>{if(t.props.id===a){const r={id:i.props.id,name:i.props.name,content:i.props.content,position:i.props.position,variables:i.props.variables,viewInside:i.props.viewInside},o=[...t.props.functions,r];return{content:"contract",props:{id:a,name:t.props.name,content:t.props.content,position:t.props.position,functions:o,variables:o}}}return t})),C(e=>e.filter(t=>t.props.id!==i.props.id))},f=(a,i)=>{b(e=>e.map(t=>{if(t.props.id===a){const r=t.props.functions.find(R=>R.id===i);if(r){const R={content:"function",props:{id:r.id,name:r.name,position:r.position,content:r.content,variables:r.variables,viewInside:r.viewInside}};x(R)}const o=t.props.functions.filter(R=>R.id!==i);return{content:"contract",props:{id:a,name:t.props.name,content:t.props.content,position:t.props.position,functions:o,variables:t.props.variables}}}return t}))},u=(a,i)=>{b(e=>e.map(t=>{const r=t.props.functions.map(o=>o.id===a?{...o,name:i}:o);return{...t,props:{...t.props,functions:r}}})),C(e=>e.map(t=>t.props.id===a?{...t,props:{...t.props,name:i}}:t))},V=(a,i)=>{b(e=>e.map(t=>{const r=t.props.functions.map(o=>o.id===a?{...o,viewInside:i}:o);return{...t,props:{...t.props,functions:r}}})),C(e=>e.map(t=>t.props.id===a?{...t,props:{...t.props,viewInside:i}}:t))},E=a=>{for(const e of D){const t=e.props.functions.find(r=>r.id===a);if(t)return t.name}const i=y.find(e=>e.props.id===a);return i?i.props.name:""},S=a=>{for(const e of D){const t=e.props.functions.find(r=>r.id===a);if(t)return t.viewInside}const i=y.find(e=>e.props.id===a);return i?i.props.viewInside:!0},I=(a,i,e)=>{b(t=>t.map(r=>{if(r.props.id===a)return{...r,props:{...r.props,position:{x:i,y:e}}};const o=r.props.functions.map(d=>d.id===a?{...d,position:{x:i,y:e}}:d);return{...r,props:{...r.props,functions:o}}})),C(t=>t.map(r=>r.props.id===a?{...r,props:{...r.props,position:{x:i,y:e}}}:r))};return s(z.Provider,{value:{contracts:D,functions:y,addContract:K,addFunction:x,addFunctionToContract:T,delFunctionContract:f,changeFunctionName:u,getFunctionName:E,getFunctionView:S,updatePosition:I,changeFunctionView:V},children:n})};function ct({id:n,content:D}){const{attributes:b,listeners:y,setNodeRef:C,setActivatorNodeRef:K,transform:x,transition:T,isDragging:f}=st({id:n}),u=A(null),{changeFunctionName:V,getFunctionName:E}=q(z),[S,I]=F(D),a=e=>{I(e.target.value),V(n,e.target.value)},i=x?{transform:`translate3d(${x.x}px, ${x.y}px, 0)`,opacity:f?.6:1}:{};return L("div",{id:n,ref:C,style:{...i},className:"mb-4 flex h-12 w-64 place-items-center rounded-lg border border-black bg-white font-medium text-black text-sm",...b,children:[s("input",{type:"text",ref:u,value:S,onChange:a,className:"ml-4",onKeyDown:e=>{e.stopPropagation(),e.key==="Enter"&&u.current&&u.current.blur()}}),s("div",{style:{cursor:"grab"},...y,className:"mr-4 flex w-full justify-end",children:s("span",{children:":::"})})]})}function mt({id:n,content:D}){const{attributes:b,listeners:y,setNodeRef:C,setActivatorNodeRef:K,transform:x,transition:T,isDragging:f}=st({id:n});A(null);const{contracts:u,delFunctionContract:V,updatePosition:E,functions:S}=q(z),{changeFunctionName:I,getFunctionName:a,changeFunctionView:i,getFunctionView:e}=q(z),[t,r]=F(a(n)),[o,d]=F(e(n)),[R,j]=F([]),[p,m]=F([{id:"1",name:"Variable 1",content:"Variable 1"},{id:"2",name:"Variable 2",content:"Variable 1"},{id:"3",name:"Variable 3",content:"Variable 1"}]);Q(()=>{const l=u.find(c=>c.props.id===n);l&&(j(l.props.functions),m(R))},[u,n,R]);const g=l=>{r(l.target.value),I(n,l.target.value)},P=A(null),h=_(H(X),H(Y,{coordinateGetter:nt})),w=A(null),k=l=>{const{active:c,over:v,delta:J}=l,U=c.rect.current.translated;if(U&&w.current){const N=w.current.getBoundingClientRect();if(U.left<N.left||U.right>N.right||U.top<N.top||U.bottom>N.bottom){V(n,c.id.toString()),S.find(G=>G.props.id===c.id)&&E(c.id.toString(),U.left,U.top),j(G=>G.filter(O=>O.id!==c.id)),m(G=>G.filter(O=>O.id!==c.id));return}}v&&c?.id!==v?.id&&m(N=>{const B=N.findIndex($=>$.id===c?.id),G=N.findIndex($=>$.id===v?.id);return rt(N,B,G)})};return L("div",{id:n,ref:C,style:{transform:x?`translate3d(${x.x}px, ${x.y}px, 0)`:void 0,opacity:f?.6:1},className:"my-4 flex h-fit w-80 flex-col rounded-lg border border-black bg-white font-medium text-black text-sm",...b,children:[L("div",{className:"mt-2 flex h-12 w-full flex-row items-center justify-start",children:[o?s(it,{onClick:()=>{d(!1),i(n,!1)},className:"ml-2 w-16"}):s(at,{onClick:()=>{d(!0),i(n,!0)},className:"ml-2 w-16"}),s("input",{type:"text",ref:P,value:t,onChange:g,className:"ml-4",onKeyDown:l=>{l.stopPropagation(),l.key==="Enter"&&P.current&&P.current.blur()}}),s("div",{style:{cursor:"grab"},...y,className:"mr-4 flex w-full justify-end",children:s("span",{children:":::"})})]}),o?s("div",{className:"my-8 flex justify-center",children:s(W,{sensors:h,collisionDetection:M,onDragEnd:k,children:s(et,{items:p,strategy:ot,children:s("ul",{children:p.map(l=>s(ct,{id:l.id,content:l.name,name:l.name},l.id))})})})}):s("div",{className:"my-2"})]})}function gt({id:n,name:D,position:b}){const{attributes:y,listeners:C,setNodeRef:K,transform:x,isDragging:T}=tt({id:n}),{contracts:f,delFunctionContract:u,updatePosition:V}=q(z),E=A(null),S=_(H(X),H(Y,{coordinateGetter:nt})),I=A(null),a=p=>{const{active:m,over:g,delta:P}=p;console.log("end drag !!!");const h=m.rect.current.translated;if(h&&I.current){const w=I.current.getBoundingClientRect();if(h.left<w.left||h.right>w.right||h.top<w.top||h.bottom>w.bottom){u(n,m.id.toString()),e.find(l=>l.id===m.id)&&V(m.id.toString(),h.left,h.top),t(l=>l.filter(v=>v.id!==m.id)),o(l=>l.filter(v=>v.id!==m.id));return}}g&&m?.id!==g?.id&&o(w=>{const k=w.findIndex(c=>c.id===m?.id),l=w.findIndex(c=>c.id===g?.id);return rt(w,k,l)})},i=p=>{console.log("start drag !!!")},[e,t]=F([]);Q(()=>{const p=f.find(m=>m.props.id===n);p&&(t(p.props.functions),o(e))},[f,n,e]);const[r,o]=F(e),[d,R]=F(D),j=p=>{R(p.target.value)};return L("div",{id:n,ref:I,style:{transform:x?`translate3d(${x.x}px, ${x.y}px, 0)`:void 0,left:`${b.x}px`,top:`${b.y}px`,position:"absolute",opacity:T?.6:1},className:"flex h-fit w-96 flex-col rounded-lg border-2 border-black bg-white font-medium text-black text-sm",...y,children:[L("div",{className:"mt-4 flex h-12 w-full flex-row items-center justify-start",children:[s("input",{type:"text",ref:E,value:d,onChange:j,className:"ml-4",onKeyDown:p=>{p.stopPropagation(),p.key==="Enter"&&E.current&&E.current.blur()}}),s("div",{style:{cursor:"grab"},...C,className:"mr-4 flex w-full justify-end",children:s("span",{children:":::"})})]}),s("div",{className:"my-8 flex justify-center",children:s(W,{sensors:S,collisionDetection:M,onDragEnd:a,onDragStart:i,children:s(et,{items:r,strategy:ot,children:s("ul",{children:r.map(p=>s(mt,{id:p.id,content:p.name,name:p.name,variables:p.variables},p.id))})})})})]})}function bt({id:n,content:D,name:b,position:y}){const{attributes:C,listeners:K,setNodeRef:x,setActivatorNodeRef:T,transform:f,isDragging:u}=tt({id:n});A(null);const{contracts:V,delFunctionContract:E,updatePosition:S,functions:I}=q(z),{changeFunctionName:a,getFunctionName:i,changeFunctionView:e,getFunctionView:t}=q(z),[r,o]=F(i(n)),[d,R]=F(t(n)),[j,p]=F([]),[m,g]=F([{id:"1",name:"Variable 1",content:"Variable 1"},{id:"2",name:"Variable 2",content:"Variable 1"},{id:"3",name:"Variable 3",content:"Variable 1"}]);Q(()=>{const c=V.find(v=>v.props.id===n);c&&(p(c.props.functions),g(j))},[V,n,j]);const P=c=>{o(c.target.value),a(n,c.target.value)},h=A(null),w=_(H(X),H(Y,{coordinateGetter:nt})),k=A(null),l=c=>{const{active:v,over:J,delta:U}=c,N=v.rect.current.translated;if(N&&k.current){const B=k.current.getBoundingClientRect();if(N.left<B.left||N.right>B.right||N.top<B.top||N.bottom>B.bottom){I.find($=>$.props.id===v.id)&&S(v.id.toString(),N.left,N.top),p($=>$.filter(Z=>Z.id!==v.id)),g($=>$.filter(Z=>Z.id!==v.id));return}}J&&v?.id!==J?.id&&g(B=>{const G=B.findIndex(O=>O.id===v?.id),$=B.findIndex(O=>O.id===J?.id);return rt(B,G,$)})};return L("div",{id:n,ref:k,style:{transform:f?`translate3d(${f.x}px, ${f.y}px, 0)`:void 0,left:`${y.x}px`,top:`${y.y}px`,position:"absolute",opacity:u?.6:1},className:"flex h-fit w-80 flex-col rounded-lg border-2 border-black bg-white font-medium text-black text-sm",...C,children:[L("div",{className:"mt-2 flex h-12 w-full flex-row items-center justify-start",children:[d?s(it,{onClick:()=>{R(!1),e(n,!1)},className:"ml-2 w-16"}):s(at,{onClick:()=>{R(!0),e(n,!0)},className:"ml-2 w-16"}),s("input",{type:"text",ref:h,value:r,onChange:P,className:"ml-2",onKeyDown:c=>{c.stopPropagation(),c.key==="Enter"&&h.current&&h.current.blur()}}),s("div",{style:{cursor:"grab"},...K,className:"mr-4 flex w-full justify-end",children:s("span",{children:":::"})})]}),d?s("div",{className:"my-8 flex justify-center",children:s(W,{sensors:w,collisionDetection:M,onDragEnd:l,children:s(et,{items:m,strategy:ot,children:s("ul",{children:m.map(c=>s(ct,{id:c.id,content:c.name,name:c.name},c.id))})})})}):s("div",{className:"my-2"})]})}function xt({id:n,content:D,name:b,position:y}){const{attributes:C,listeners:K,setNodeRef:x,setActivatorNodeRef:T,transform:f}=tt({id:n}),u=A(null),{changeFunctionName:V,getFunctionName:E}=q(z),[S,I]=F(E(n)),a=i=>{I(i.target.value),V(n,i.target.value)};return L("div",{id:n,ref:x,style:{transform:f?`translate3d(${f.x}px, ${f.y}px, 0)`:void 0,left:`${y.x}px`,top:`${y.y}px`,position:"absolute"},className:"absolute mb-4 flex h-12 w-64 place-items-center rounded-lg border border-black bg-white font-medium text-black text-sm",...C,children:[s("input",{type:"text",ref:u,value:S,onChange:a,className:"ml-4",onKeyDown:i=>{i.stopPropagation(),i.key==="Enter"&&u.current&&u.current.blur()}}),s("div",{style:{cursor:"grab"},...K,className:"mr-4 flex w-full justify-end",children:s("span",{children:":::"})})]})}const ht={display:"flex"};function vt({children:n}){const{isOver:D,setNodeRef:b}=dt({id:"droppable"});return s("div",{ref:b,style:{...{color:D?"green":void 0},...ht},children:n})}const yt=["contract","function"];function wt({draggable:n}){if(n.content==="function")return s(bt,{...n.props});if(n.content==="contract")return s(gt,{...n.props});if(n.content==="variable")return s(xt,{...n.props});throw Error("Invalid draggable")}const Ct=n=>{if(n.content==="function")return{...n,props:{id:n.props.id,content:n.content,name:n.content,position:n.props.position}};if(n.content==="contract")return{...n,props:{id:n.props.id,content:n.content,name:n.content,position:n.props.position}};if(n.content==="variable")return{...n,props:{id:n.props.id,content:n.content,name:n.content,position:n.props.position}};throw Error("Invalid content")};function Nt(){const{contracts:n,functions:D,addContract:b,addFunctionToContract:y,addFunction:C,getFunctionName:K,updatePosition:x}=q(z),[T,f]=F([]);Q(()=>{const e=n.map(o=>({content:o.content,props:{id:o.props.id,name:o.props.name,content:o.props.content,position:o.props.position,functions:o.props.functions,variables:o.props.variables}})),t=D.map(o=>({content:o.content,props:{id:o.props.id,name:o.props.name,content:o.props.content,position:o.props.position,variables:o.props.variables,viewInside:o.props.viewInside}})),r=[...e,...t];f(r)},[n,D]);const u=A(null);function V(e){const{active:t}=e;T.find(r=>r.props.id===t.id)}function E(e){const{active:t,delta:r}=e,o=T.find(g=>g.props.id===t.id);if(console.log(o),!o||!u.current)return;const d={x:o.props.position.x+r.x,y:o.props.position.y+r.y},R=T.filter(g=>g.content==="contract");if(o.content==="function")for(const g of R){const P=document.getElementById(o.props.id),h=document.getElementById(g.props.id);if(P&&h){const w=P.getBoundingClientRect(),k=h.getBoundingClientRect();if(w.left<k.right&&w.right>k.left&&w.top<k.bottom&&w.bottom>k.top){console.log("Le DraggableFunction est au-dessus du DraggableContract."),f(c=>c.filter(v=>v.props.id!==o.props.id)),a(g.props.id,o);return}}}const j=u.current.getBoundingClientRect(),m=document.getElementById(o.props.id)?.getBoundingClientRect();if(m&&d.x>=j.left&&d.x+m.width<=j.right&&d.y>=j.top&&d.y+m.height<=j.bottom){const g={...o,position:d};g.props.position=d,x(t.id.toString(),d.x,d.y),f(P=>P.map(h=>h.props.id===g.props.id?g:h))}else console.log("Drag annulé : l'élément n'est pas entièrement à l'intérieur de la zone droppable.")}const S=(e,t,r)=>{const o={content:"contract",props:{id:e,name:"contract",content:"contract",position:{x:t,y:r},functions:[],variables:[]}};console.log("call addContract"),b(o)},I=(e,t,r)=>{C({content:"function",props:{id:e,name:"function",content:"function",position:{x:t,y:r},variables:[],viewInside:!0}})},a=(e,t)=>{const r={content:"function",props:{id:t.props.id,name:K(t.props.id),content:t.props.content,position:t.props.position,variables:t.props.variables,viewInside:t.props.viewInside}};y(e,r)};function i(e){if(u.current){const t=u.current.getBoundingClientRect(),r=`${e}-${Date.now()}`;e==="contract"?S(r,t.left+25,t.top+25):e==="function"&&I(r,t.left+25,t.top+25);const o=Ct({content:e,props:{id:r,name:e,content:e,position:{x:t.left+25,y:t.top+25},variables:[]}});f(d=>[...d,o])}}return L("div",{className:"flex w-screen flex-row",children:[s("div",{className:"flex w-1/6 flex-col justify-center gap-4",children:yt.map(e=>s(pt,{className:"mx-4",onClick:()=>i(e),children:e},e))}),s(W,{onDragStart:V,onDragEnd:E,children:s("div",{ref:u,className:"mx-4 h-screen w-full justify-center border-2 border-white",children:s(vt,{children:T.map(e=>s(wt,{draggable:e},e.props.id))})})})]})}const St=function(){return s(ft,{children:s(Nt,{})})};export{St as component};
